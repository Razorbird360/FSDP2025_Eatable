generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(uuid()) @db.Uuid
  email       String   @unique
  displayName String   @map("display_name")
  role        String   @default("user") // user | stall_owner | admin
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  ownedStalls   Stall[]
  mediaUploads  MediaUpload[]
  votes         MediaUploadVote[]
  orders        Order[]

  @@map("users")
}

model Stall {
  id          String   @id @default(uuid()) @db.Uuid
  ownerId     String?  @map("owner_id") @db.Uuid
  name        String   @unique
  description String?
  location    String?
  latitude    Float?   @db.DoublePrecision
  longitude   Float?   @db.DoublePrecision
  isVerified  Boolean  @default(false) @map("is_verified")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  owner     User?      @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  menuItems MenuItem[]
  orders    Order[]

  @@map("stalls")
}

model MenuItem {
  id          String   @id @default(uuid()) @db.Uuid
  stallId     String   @map("stall_id") @db.Uuid
  name        String
  description String?
  priceCents  Int      @map("price_cents")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  stall        Stall         @relation(fields: [stallId], references: [id], onDelete: Cascade)
  mediaUploads MediaUpload[]
  orderItems   OrderItem[]

  @@unique([stallId, name])
  @@map("menu_items")
}

model MediaUpload {
  id         String   @id @default(uuid()) @db.Uuid
  menuItemId String   @map("menu_item_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  imageUrl   String   @map("image_url")
  caption    String?
  aiVerified Boolean  @default(false) @map("ai_verified")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  menuItem MenuItem          @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes    MediaUploadVote[]

  @@map("media_uploads")
}

model MediaUploadVote {
  uploadId  String   @map("upload_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  vote      Int      @default(1) @db.SmallInt
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  upload MediaUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([uploadId, userId])
  @@map("media_upload_votes")
}

model Order {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  stallId    String   @map("stall_id") @db.Uuid
  status     String   @default("pending")
  totalCents Int      @default(0) @map("total_cents")
  netsTxnId  String?  @map("nets_txn_id")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  stall      Stall       @relation(fields: [stallId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@map("orders")
}

model OrderItem {
  id         String @id @default(uuid()) @db.Uuid
  orderId    String @map("order_id") @db.Uuid
  menuItemId String @map("menu_item_id") @db.Uuid
  quantity   Int    @default(1)
  unitCents  Int    @map("unit_cents")

  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])

  @@map("order_items")
}
