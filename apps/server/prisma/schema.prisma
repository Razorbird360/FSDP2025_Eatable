generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String              @id @default(uuid()) @db.Uuid
  email                   String              @unique
  displayName             String              @map("display_name")
  role                    String              @default("user")
  createdAt               DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  username                String              @unique
  skipOnboarding          Boolean             @default(false) @map("skip_Onboarding")
  first_name              String?
  last_name               String?
  location                String?
  description             String?
  verified                Boolean?
  verificationPhotoUrl    String?             @map("verification_photo_url")
  verificationSubmittedAt DateTime?           @map("verification_submitted_at") @db.Timestamptz(6)
  phone                   String?
  language                String?
  reports                 ContentReport[]
  votes                   MediaUploadVote[]
  mediaUploads            MediaUpload[]
  orders                  Order[]
  ownedStalls             Stall[]
  user_cart               user_cart[]
  favorites               UserFavorite[]
  userVouchers            UserVoucher[]
  discounts_charges       discounts_charges[]
  achievements            UserAchievement[]
  monthlyActions          UserMonthlyAction[]
  monthlyBudgets          UserMonthlyBudget[]

  @@map("users")
}

model Stall {
  id             String         @id @default(uuid()) @db.Uuid
  ownerId        String?        @map("owner_id") @db.Uuid
  name           String         @unique
  description    String?
  location       String?
  cuisineType    String?        @map("cuisine_type")
  tags           String[]       @default([])
  dietaryTags    String[]       @default([]) @map("dietary_tags")
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  image_url      String?
  hawkerCentreId String?        @map("hawker_centre_id") @db.Uuid
  menuItems      MenuItem[]
  orders         Order[]
  hawkerCentre   HawkerCentre?  @relation(fields: [hawkerCentreId], references: [id], onUpdate: NoAction)
  owner          User?          @relation(fields: [ownerId], references: [id])
  favorites      UserFavorite[]

  @@map("stalls")
}

model MenuItem {
  id           String         @id @default(uuid()) @db.Uuid
  stallId      String         @map("stall_id") @db.Uuid
  name         String
  description  String?
  priceCents   Int            @map("price_cents")
  category     String?
  prepTimeMins Int?           @map("prep_time_mins")
  isActive     Boolean        @default(true) @map("is_active")
  createdAt    DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  imageUrl     String?        @map("image_url")
  mediaUploads MediaUpload[]
  menuItemTagAggs MenuItemTagAgg[]
  stall        Stall          @relation(fields: [stallId], references: [id], onDelete: Cascade)
  orderItems   OrderItem[]
  user_cart    user_cart[]
  favorites    UserFavorite[]

  @@unique([stallId, name])
  @@map("menu_items")
}

model MediaUpload {
  id                String            @id @default(uuid()) @db.Uuid
  menuItemId        String            @map("menu_item_id") @db.Uuid
  userId            String            @map("user_id") @db.Uuid
  imageUrl          String            @map("image_url")
  caption           String?
  validationStatus  String            @default("pending") @map("validation_status")
  reviewedAt        DateTime?         @map("reviewed_at") @db.Timestamptz(6)
  reviewedBy        String?           @map("reviewed_by") @db.Uuid
  upvoteCount       Int               @default(0) @map("upvote_count")
  downvoteCount     Int               @default(0) @map("downvote_count")
  voteScore         Int               @default(0) @map("vote_score")
  createdAt         DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  aspectRatio       String?           @map("aspect_ratio")
  reports           ContentReport[]
  votes             MediaUploadVote[]
  uploadTags        UploadTag[]
  menuItem          MenuItem          @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("media_uploads")
}

model Tag {
  id           String            @id @default(uuid()) @db.Uuid
  normalized   String            @unique
  displayLabel String            @map("display_label")
  createdAt    DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  uploadTags   UploadTag[]
  menuItemAggs MenuItemTagAgg[]

  @@map("tags")
}

model UploadTag {
  id           String       @id @default(uuid()) @db.Uuid
  uploadId     String       @map("upload_id") @db.Uuid
  tagId        String       @map("tag_id") @db.Uuid
  confidence   Float
  evidenceFrom Json         @map("evidence_from")
  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  upload       MediaUpload  @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  tag          Tag          @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@map("upload_tags")
}

model MenuItemTagAgg {
  id         String   @id @default(uuid()) @db.Uuid
  menuItemId String   @map("menu_item_id") @db.Uuid
  tagId      String   @map("tag_id") @db.Uuid
  count      Int      @default(0)
  avgConfidence Float? @map("avg_confidence")
  lastSeenAt DateTime @default(now()) @map("last_seen_at") @db.Timestamptz(6)
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, tagId])
  @@map("menu_item_tag_aggs")
}

model MediaUploadVote {
  uploadId  String      @map("upload_id") @db.Uuid
  userId    String      @map("user_id") @db.Uuid
  vote      Int         @db.SmallInt
  createdAt DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  upload    MediaUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([uploadId, userId])
  @@map("media_upload_votes")
}

model Order {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String              @map("user_id") @db.Uuid
  stallId            String              @map("stall_id") @db.Uuid
  status             String              @default("pending")
  orderStatus        String              @default("awaiting") @map("order_status")
  orderCode          String?             @map("order_code") @db.Char(4)
  totalCents         Int                 @default(0) @map("total_cents")
  netsTxnId          String?             @map("nets_txn_id")

  // countdown clock time (already)
  estimatedReadyTime DateTime?           @map("estimated_ready_time") @db.Timestamptz(6)

  //  add these
  acceptedAt         DateTime?           @map("accepted_at") @db.Timestamptz(6)
  estimatedMinutes   Int?                @map("estimated_minutes")
  readyAt            DateTime?           @map("ready_at") @db.Timestamptz(6)
  collectedAt        DateTime?           @map("collected_at") @db.Timestamptz(6)

  //  QR security (recommended)
  pickupTokenHash    String?             @map("pickup_token_hash")
  pickupTokenUsedAt  DateTime?           @map("pickup_token_used_at") @db.Timestamptz(6)
  pickupToken String?                    @map("pickup_token")


  completedAt        DateTime?           @map("completed_at") @db.Timestamptz(6)
  createdAt          DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)

  discounts_charges  discounts_charges[]
  orderItems         OrderItem[]
  stall              Stall               @relation(fields: [stallId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([stallId, orderCode])
  @@map("orders")
}


model OrderItem {
  id         String   @id @default(uuid()) @db.Uuid
  orderId    String   @map("order_id") @db.Uuid
  menuItemId String   @map("menu_item_id") @db.Uuid
  quantity   Int      @default(1)
  unitCents  Int      @map("unit_cents")
  isPrepared Boolean  @default(false) @map("is_prepared")

  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  request    String?  @default("")
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_items")
}


model UserFavorite {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  menuItemId String?   @map("menu_item_id") @db.Uuid
  stallId    String?   @map("stall_id") @db.Uuid
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  menuItem   MenuItem? @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  stall      Stall?    @relation(fields: [stallId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, menuItemId])
  @@unique([userId, stallId])
  @@map("user_favorites")
}

model ContentReport {
  id         String      @id @default(uuid()) @db.Uuid
  uploadId   String      @map("upload_id") @db.Uuid
  reporterId String      @map("reporter_id") @db.Uuid
  reason     String
  status     String      @default("pending")
  createdAt  DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  details    String      @default("")
  reporter   User        @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  upload     MediaUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  @@map("content_reports")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model user_cart {
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  userid     String?   @db.Uuid
  itemid     String?   @db.Uuid
  qty        Int?
  request    String?
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  menu_items MenuItem? @relation(fields: [itemid], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users      User?     @relation(fields: [userid], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model HawkerCentre {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String
  slug       String   @unique
  address    String?
  postalCode String?  @map("postal_code")
  latitude   Float
  longitude  Float
  imageUrl   String?  @map("image_url")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  stalls     Stall[]

  @@map("hawker_centres")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model system_configuration {
  id              BigInt   @id @default(autoincrement())
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  servicefeecents Int?     @default(0)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model discounts_charges {
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  type        String?
  orderId     String?  @db.Uuid
  amountCents Float?   @db.Real
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String?       @map("user_id") @db.Uuid
  userVoucherId   String?       @map("user_voucher_id") @db.Uuid
  orders          Order?        @relation(fields: [orderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user            User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userVoucher     UserVoucher?  @relation(fields: [userVoucherId], references: [id], onDelete: SetNull)
}

model ExistingVoucher {
  id             String        @id @default(uuid()) @db.Uuid
  code           String        @unique
  description    String?
  discountAmount Int           @default(0) @map("discount_amount")
  discountType   String        @default("fixed") @map("discount_type")
  minSpend       Int           @default(0) @map("min_spend")
  expiryDate     DateTime?     @map("expiry_date") @db.Timestamptz(6)
  expiryOnReceiveMonths Int?   @map("expiry_on_receive_months")
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  userVouchers   UserVoucher[]

  @@map("existing_vouchers")
}

model UserVoucher {
  id        String          @id @default(uuid()) @db.Uuid
  userId    String          @map("user_id") @db.Uuid
  voucherId String          @map("voucher_id") @db.Uuid
  isUsed    Boolean         @default(false) @map("is_used")
  expiryDate DateTime?      @map("expiry_date") @db.Timestamptz(6)
  createdAt DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  voucher   ExistingVoucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  discounts_charges discounts_charges[]

  @@map("user_vouchers")
}

model Achievement {
  id          String            @id @default(uuid()) @db.Uuid
  code        String            @unique // e.g., "VOTER_REWARD"
  name        String
  description String?
  type        String?
  target      Int?
  rewardCode  String?           @map("reward_code")
  isOneTime   Boolean           @default(false) @map("is_one_time")
  badgeUrl    String?           @map("badge_url")
  createdAt   DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  users       UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(uuid()) @db.Uuid
  userId        String      @map("user_id") @db.Uuid
  achievementId String      @map("achievement_id") @db.Uuid
  unlockedAt    DateTime    @default(now()) @map("unlocked_at") @db.Timestamptz(6)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model UserMonthlyAction {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  monthYear   String   @map("month_year") // Format: "YYYY-MM"
  voteCount   Int      @default(0) @map("vote_count")
  uploadCount Int      @default(0) @map("upload_count")
  rewarded    Boolean  @default(false) // Whether the monthly voucher has been issued
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, monthYear])
  @@map("user_monthly_actions")
}

model UserMonthlyBudget {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  userId          String   @map("user_id") @db.Uuid
  year            Int
  month           Int        // 1â€“12

  budgetCents     Int      @map("budget_cents")
  alertAtPercent  Int      @default(80) @map("alert_at_percent")
  alerted  Boolean  @default(false)
  notifiedAlready  Boolean  @default(false)

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, month])
  @@map("user_monthly_budgets")
}
